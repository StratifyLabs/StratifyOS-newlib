project(newlib CXX C)


# The include files need to be synced with the ones in the system include folder
file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/src/libc/include DESTINATION ${CMSDK_LOCAL_PATH}/arm-none-eabi)

set(PUBLIC_DEFINITIONS
	-D__StratifyOS__
	)

set(PRIVATE_DEFINITIONS
	-DPACKAGE_NAME=\"newlib\"
	-DPACKAGE_TARNAME=\"newlib\"
	-DPACKAGE_VERSION=\"2.3.0\"
	-DPACKAGE_STRING=\"newlib\ 2.3.0\"
	-DPACKAGE_BUGREPORT=\"\"
#	-DPACKAGE_URL=\"\"
	-D__NO_SYSCALLS__
	-DSIGNAL_PROVIDED
	-DMALLOC_PROVIDED
	-DHAVE_SYSTEM
	-DHAVE_FCNTL
	-DHAVE_RENAME
	-D_COMPILING_NEWLIB=1
	-D__BUFSIZ__=64
# this causes problems when printing floats
#	-D_DOUBLE_IS_32BITS=1
	-D__IEEE_LITTLE_ENDIAN
	-D__IEEE_BYTES_LITTLE_ENDIAN
	)

set(BUILD_FLAGS
	-fno-builtin
	-fsingle-precision-constant
	-ffunction-sections
	-fdata-sections
	-Wno-overflow
	)

set(LIBC_NAME newlib_libc)
set(LIBM_NAME newlib_libm)
set(LIBA_NAME newlib_liba)

cmsdk2_add_library(
	NAME ${LIBC_NAME}
	CONFIG release
	ARCH ${CMSDK_ARCH}
	TARGET LIBC_RELEASE_TARGET)

cmsdk2_add_library(
	NAME ${LIBM_NAME}
	CONFIG release
	ARCH ${CMSDK_ARCH}
	TARGET LIBM_RELEASE_TARGET)

cmsdk2_add_sources(
	TARGET ${LIBC_RELEASE_TARGET}
	DIRECTORY src/libc)

cmsdk2_add_sources(
	TARGET ${LIBM_RELEASE_TARGET}
	DIRECTORY src/libm)

target_sources(${LIBC_RELEASE_TARGET}
	PUBLIC
	PRIVATE
	${LIBC_SOURCES}
	)

target_sources(${LIBM_RELEASE_TARGET}
	PUBLIC
	PRIVATE
	${LIBM_SOURCES}
	)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	TYPE OBJECT
	OPTION vsprintf
	CONFIG release
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VSPRINTF_RELEASE_TARGET)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	TYPE OBJECT
	OPTION vprintf
	CONFIG release
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VPRINTF_RELEASE_TARGET)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	TYPE OBJECT
	OPTION vsiprintf
	CONFIG release
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VSIPRINTF_RELEASE_TARGET)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	TYPE OBJECT
	OPTION viprintf
	CONFIG release
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VIPRINTF_RELEASE_TARGET)

set(LIBA_SOURCES
	${CMAKE_CURRENT_SOURCE_DIR}/src/libc/stdio/vfprintf.c
	${CMAKE_CURRENT_SOURCE_DIR}/src/libc/stdio/vfscanf.c
	${CMAKE_CURRENT_SOURCE_DIR}/src/libc/stdio/vfwscanf.c
	${CMAKE_CURRENT_SOURCE_DIR}/src/libc/stdio/vfwprintf.c
)

target_sources(${LIBA_VSPRINTF_RELEASE_TARGET}
	PRIVATE
	${LIBA_SOURCES})

target_sources(${LIBA_VPRINTF_RELEASE_TARGET}
	PRIVATE
	${LIBA_SOURCES})

target_sources(${LIBA_VSIPRINTF_RELEASE_TARGET}
	PRIVATE
	${LIBA_SOURCES})

target_sources(${LIBA_VIPRINTF_RELEASE_TARGET}
	PRIVATE
	${LIBA_SOURCES})

target_compile_definitions(${LIBA_VSPRINTF_RELEASE_TARGET}
	PUBLIC
	${PUBLIC_DEFINITIONS}
	PRIVATE
	${PRIVATE_DEFINITIONS}
	-DSTRING_ONLY)

target_compile_definitions(${LIBA_VPRINTF_RELEASE_TARGET}
	PUBLIC
	${PUBLIC_DEFINITIONS}
	PRIVATE
	${PRIVATE_DEFINITIONS})

target_compile_definitions(${LIBA_VSIPRINTF_RELEASE_TARGET}
	PUBLIC
	${PUBLIC_DEFINITIONS}
	PRIVATE
	${PRIVATE_DEFINITIONS}
	-DSTRING_ONLY
	-DINTEGER_ONLY)

target_compile_definitions(${LIBA_VIPRINTF_RELEASE_TARGET}
	PUBLIC
	${PUBLIC_DEFINITIONS}
	PRIVATE
	${PRIVATE_DEFINITIONS}
	-DINTEGER_ONLY)

target_compile_definitions(${LIBC_RELEASE_TARGET}
	PUBLIC
	${PUBLIC_DEFINITIONS}
	PRIVATE
	${PRIVATE_DEFINITIONS})

target_compile_definitions(${LIBM_RELEASE_TARGET}
	PUBLIC
	${PUBLIC_DEFINITIONS}
	PRIVATE
	${PRIVATE_DEFINITIONS}
	)

target_compile_options(${LIBC_RELEASE_TARGET}
	PUBLIC
	PRIVATE
	${BUILD_FLAGS})

target_compile_options(${LIBM_RELEASE_TARGET}
	PUBLIC
	PRIVATE
	${BUILD_FLAGS})

target_include_directories(${LIBC_RELEASE_TARGET}
	PUBLIC
	$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/libc/include>
	PRIVATE
	${CMAKE_CURRENT_SOURCE_DIR}/src/libc/machine/arm)

target_include_directories(${LIBM_RELEASE_TARGET}
	PUBLIC
	$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/libc/include>
	PRIVATE
	${CMAKE_CURRENT_SOURCE_DIR}/src/libc/machine/arm
	${CMAKE_CURRENT_SOURCE_DIR}/src/libm/math
	${CMAKE_CURRENT_SOURCE_DIR}/src/libm/common)

target_compile_options(${LIBC_RELEASE_TARGET}
	PRIVATE
	-Os)

target_compile_options(${LIBM_RELEASE_TARGET}
	PRIVATE
	-Os)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	OPTION vsprintf
	TYPE OBJECT
	CONFIG debug
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VSPRINTF_DEBUG_TARGET)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	OPTION vprintf
	TYPE OBJECT
	CONFIG debug
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VPRINTF_DEBUG_TARGET)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	OPTION vsiprintf
	TYPE OBJECT
	CONFIG debug
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VSIPRINTF_DEBUG_TARGET)

cmsdk2_add_library(
	NAME ${LIBA_NAME}
	OPTION viprintf
	TYPE OBJECT
	CONFIG debug
	ARCH ${CMSDK_ARCH}
	TARGET LIBA_VIPRINTF_DEBUG_TARGET)

cmsdk2_copy_target(
	SOURCE ${LIBA_VSPRINTF_RELEASE_TARGET}
	DESTINATION ${LIBA_VSPRINTF_DEBUG_TARGET})
cmsdk2_copy_target(
	SOURCE ${LIBA_VPRINTF_RELEASE_TARGET}
	DESTINATION ${LIBA_VPRINTF_DEBUG_TARGET})
cmsdk2_copy_target(
	SOURCE ${LIBA_VSIPRINTF_RELEASE_TARGET}
	DESTINATION ${LIBA_VSIPRINTF_DEBUG_TARGET})
cmsdk2_copy_target(
	SOURCE ${LIBA_VIPRINTF_RELEASE_TARGET}
	DESTINATION ${LIBA_VIPRINTF_DEBUG_TARGET})

set(DEPENDENCIES
	${LIBA_NAME}_vsprintf
	${LIBA_NAME}_vprintf
	${LIBA_NAME}_vsiprintf
	${LIBA_NAME}_viprintf)

set(LIBA_DEPENDENCIES StratifyOS_interface)

cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VSPRINTF_RELEASE_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VSIPRINTF_RELEASE_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VPRINTF_RELEASE_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VIPRINTF_RELEASE_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VSPRINTF_DEBUG_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VSIPRINTF_DEBUG_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VPRINTF_DEBUG_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBA_VIPRINTF_DEBUG_TARGET}
	DEPENDENCIES ${LIBA_DEPENDENCIES})

cmsdk2_add_library(
	NAME ${LIBC_NAME}
	CONFIG debug
	ARCH ${CMSDK_ARCH}
	TARGET LIBC_DEBUG_TARGET)

cmsdk2_add_library(
	NAME ${LIBM_NAME}
	CONFIG debug
	ARCH ${CMSDK_ARCH}
	TARGET LIBM_DEBUG_TARGET)

cmsdk2_copy_target(
	SOURCE ${LIBC_RELEASE_TARGET}
	DESTINATION ${LIBC_DEBUG_TARGET})
cmsdk2_copy_target(
	SOURCE ${LIBM_RELEASE_TARGET}
	DESTINATION ${LIBM_DEBUG_TARGET})
cmsdk2_library_add_dependencies(
	TARGET ${LIBC_RELEASE_TARGET}
	DEPENDENCIES ${DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBM_RELEASE_TARGET}
	DEPENDENCIES StratifyOS_interface)
cmsdk2_library_add_dependencies(
	TARGET ${LIBC_DEBUG_TARGET}
	DEPENDENCIES ${DEPENDENCIES})
cmsdk2_library_add_dependencies(
	TARGET ${LIBM_DEBUG_TARGET}
	DEPENDENCIES StratifyOS_interface)

install(DIRECTORY
	src/libc/include/
	DESTINATION include
	PATTERN CMakelists.txt EXCLUDE)

install(FILES
	${CMAKE_CURRENT_SOURCE_DIR}/newlib.cmake
	DESTINATION
	${CMSDK_LOCAL_PATH}/cmake/targets)


